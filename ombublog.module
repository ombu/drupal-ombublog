<?php

/**
 * @file
 * OMBU Blog Module
 *
 * Provides single-blog functionality for a drupal site. Features include:
 *   - Tags, tagging via taxonomy
 *   - Blog-only search
 */

include_once 'ombublog.features.inc';

/**
 * Constants
 */

/**
 * Base url stem for blog functionality
 */
define('OMBUBLOG_BASE_PATH', 'blog');

/**
 * Module Hooks
 */

/**
 * Implements hook_init().
 */
function ombublog_init() {
  // Redirect taxonomy terms managed by ombublog.
  $item = menu_get_item();
  if ($item['path'] == 'taxonomy/term/%' && $term = menu_get_object('taxonomy_term', 2)) {
    if ($term->vocabulary_machine_name == variable_get('ombublog_category_vocabulary', '') && variable_get('ombublog_category_redirect', 0)) {
      drupal_goto(OMBUBLOG_BASE_PATH . '/search', array(
        'query' => array(
          'category' => $term->tid,
        ),
      ));
    }
    if ($term->vocabulary_machine_name == variable_get('ombublog_tags_vocabulary', '') && variable_get('ombublog_tags_redirect', 1)) {
      drupal_goto(OMBUBLOG_BASE_PATH . '/search', array(
        'query' => array(
          'tags' => $term->name,
        ),
      ));
    }
  }
}

/**
 * Implements hook_menu().
 */
function ombublog_menu() {
  $items = array();

  $items['admin/config/user-interface/ombublog'] = array(
    'title' => 'Ombu Blog',
    'description' => 'Configuration for sitewide blog',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('ombublog_settings_form'),
    'access arguments' => array('administer ombublog'),
    'file' => 'ombublog.admin.inc',
  );

  $items[OMBUBLOG_BASE_PATH . '/%/search'] = array(
    'title' => 'Blog',
    'page callback' => 'ombublog_search_view',
    'page arguments' => array(1, 3),
    'access callback' => TRUE,
    'type' => MENU_CALLBACK,
  );

  return $items;
}

/**
 * Implements hook_admin_paths().
 */
function ombublog_admin_paths() {
  $paths = array();

  // Make sure that blog author profiles are treated like content.
  $type = profile2_type_load('blog_author');
  if ($type) {
    $path = profile2_page_get_base_path($type);
    $paths = array(
      $path . '/*/edit' => TRUE,
      $path . '/*/delete' => TRUE,
    );
  }

  return $paths;
}

/**
 * Implements hook_bean_types_api_info().
 */
function ombublog_bean_types_api_info() {
  return array(
    'api' => bean_current_version(),
  );
}

/**
 * Implements hook_bean_types().
 */
function ombublog_bean_types() {
  $plugins = array();

  $plugins['ombublog_list'] = array(
    'name' => 'ombublog_list',
    'label' => t('Latest blog posts'),
    'handler' => array(
      'class' => 'OmbublogList',
      'parent' => 'bean_default',
    ),
    'path' => drupal_get_path('module', 'ombublog') . '/includes',
    'file' => 'OmbublogList.php',
    'editable' => TRUE,
  );

  $plugins['ombublog_tags'] = array(
    'name' => 'ombublog_tags',
    'label' => t('Blog tag cloud'),
    'handler' => array(
      'class' => 'OmbublogTags',
      'parent' => 'bean_default',
    ),
    'path' => drupal_get_path('module', 'ombublog') . '/includes',
    'file' => 'OmbublogTags.php',
    'editable' => TRUE,
  );

  return $plugins;
}

/**
 * Implements hook_bean_style_info().
 */
function ombublog_bean_style_info() {
  return array(
    'ombublog_list' => array(
      'label' => 'Teaser listing',
      'class' => 'OmbublogListStyle',
      'bean_types' => array(
        'ombublog_list',
      ),
    ),
  );
}

/**
 * Implements hook_bean_style_options_alter().
 */
function ombublog_bean_style_options_alter(&$options, $context) {
  if ($context['bundle'] == 'ombublog_list') {
    unset($options['']);
  }
}

/**
 * Implements hook_theme().
 */
function ombublog_theme() {
  return array(
    'taxonomy_comma_list' => array(
      'render element' => 'element',
    ),
    'ombublog_archive_list' => array(
      'variables' => array('options' => array()),
    ),
  );
}

/**
 * Implements hook_permissions().
 */
function ombublog_permissions() {
  return array(
    'administer ombublogs' => array(
      'title' => t('Administer Blogs'),
    ),
  );
}

/**
 * Implements hook_module_implements_alter().
 */
function ombublog_module_implements_alter(&$implementations, $hook) {
  if ($hook == 'form_alter') {
    $group = $implementations['ombublog'];
    unset($implementations['ombublog']);
    $implementations['ombublog'] = $group;
  }
}

/**
 * Implements hook_image_default_styles().
 */
function ombublog_image_default_styles() {
  $styles = array();

  $styles['blog_teaser'] = array(
    'effects' => array(
      array(
        'name' => 'image_scale',
        'data' => array('width' => 251, 'height' => 134, 'upscale' => 0),
        'weight' => 0,
      ),
    ),
  );

  $styles['blog_post'] = array(
    'effects' => array(
      array(
        'name' => 'image_scale',
        'data' => array('width' => 408, 'height' => 300, 'upscale' => 0),
        'weight' => 0,
      ),
    ),
  );
  return $styles;
}

/**
 * Implements hook_block_info().
 */
function ombublog_block_info() {
  $blocks['archive_list'] = array(
    'info' => t('OMBU Blog Archive list'),
    'cache' => DRUPAL_CACHE_PER_PAGE,
  );

  $blocks['tags_list'] = array(
    'info' => t('OMBU Blog Tags list'),
    'cache' => DRUPAL_CACHE_PER_PAGE,
  );

  $blocks['rss_feed'] = array(
    'info' => t('OMBU Blog RSS feed icon'),
    'cache' => DRUPAL_CACHE_PER_PAGE,
  );

  $blocks['search'] = array(
    'info' => t('OMBU Blog Search Form'),
    'cache' => DRUPAL_NO_CACHE,
  );

  return $blocks;
}

/**
 * Implements hook_block_view().
 */
function ombublog_block_view($delta = 0) {
  $block = array();

  switch ($delta) {
    case 'search':
      $block['content'] = drupal_get_form('ombublog_search_form');
      break;

    case 'archive_list':
      $block['subject'] = t('Archives');
      $block['content'] = ombublog_archive_block();
      break;

    case 'tags_list':
      $block['subject'] = t('Categories');
      $block['content'] = _ombublog_block_get_tags_list();
      break;

    case 'rss_feed':
      $block['content'] = _ombublog_block_get_rss_feed();
      break;
  }

  return $block;
}

/**
 * Render a search form for the blog.
 */
function ombublog_search_form($form, &$form_state, $keys = '') {
  // Add CSS
  drupal_add_css(drupal_get_path('module', 'search') .'/search.css', 'module', 'all', FALSE);

  $form = array(
    '#action' => base_path() . OMBUBLOG_BASE_PATH . '/search',
    '#attributes' => array('class' => 'search-form'),
  );
  $form['basic']['inline'] = array('#prefix' => '<div class="container-inline">', '#suffix' => '</div>');
  $form['basic']['inline']['keys'] = array(
    '#type' => 'textfield',
    '#title' => '',
    '#default_value' => $keys,
    '#maxlength' => 255,
    '#size' => 30,
  );
  $form['basic']['inline']['keys']['#attributes']['placeholder'] = 'Keywords';
  // processed_keys is used to coordinate keyword passing between other forms
  // that hook into the basic search form.
  $form['basic']['inline']['processed_keys'] = array('#type' => 'value', '#value' => array());
  $form['basic']['inline']['submit'] = array('#type' => 'submit', '#value' => t('Search Blog'));

  return $form;
}

/**
 * Implements hook_entity_info_alter().
 */
function ombublog_entity_info_alter(&$entity_info) {
  // Alter label callback for blog authors in order to show display name as
  // title.
  $entity_info['profile2']['label callback'] = 'ombublog_profile2_label';
}

/**
 * Label callback for blog author profile.
 *
 * Shows display name as label instead of "Blog author".
 */
function ombublog_profile2_label($profile) {
  if ($profile->type == 'blog_author') {
    $display_name = field_get_items('profile2', $profile, 'field_display_name');
    if ($display_name) {
      return $display_name[0]['value'];
    }
  }

  return $profile->defaultLabel();
}

/**
 * Implements hook_form_alter().
 */
function ombublog_form_alter(&$form, $form_state, $form_id) {
  // Hide the path tab for blog posts.
  if ($form_id == 'blog_post_node_form') {
    $form['path']['#access'] = FALSE;
  }
}

/**
 * Implements hook_node_view().
 */
function ombublog_node_view($node, $view_mode, $langcode) {
  if ($node->type == 'blog_post') {
    if ($view_mode != 'full') {
      // Build blog links.
      $links = array();

      // Add comment links.
      if (module_exists('comment')) {
        if ($node->comment_count == 0) {
          $links['comments'] = array(
            'title' => 'Leave a Comment',
            'href' => 'node/' . $node->nid,
            'fragment' => 'comments',
            'attributes' => array('class' => array('read-more')),
          );
        }
        else {
          $links['comments'] = array(
            'title' => 'Comments (' . $node->comment_count . ')',
            'href' => 'node/' . $node->nid,
            'fragment' => 'comments',
            'attributes' => array('class' => array('read-more')),
          );
        }
      }

      if ($links) {
        $node->content['links']['blog'] = array(
          '#theme' => 'links__node__blog',
          '#links' => $links,
          '#attributes' => array('class' => array('links', 'inline')),
        );
      }
    }
  }

  // Render taxonomy terms in a comma seprated list.
  if (isset($node->content['field_tags'])) {
    $node->content['field_tags']['#theme'] = 'taxonomy_comma_list';
  }

  // Don't show the link to "feature" this item.
  unset($node->content['links']['flag']);
  unset($node->content['links']['comment']);
}

/**
 * Implements hook_preprocess_node().
 */
function ombublog_preprocess_node(&$variables) {
  // Add schema.org microdata to blog posts.
  if ($variables['type'] == 'blog_post') {
    $variables['attributes_array']['infoscope'] = '';
    $variables['attributes_array']['itemtype'] = 'http://schema.org/BlogPosting';
    $variables['title_attributes_array']['itemprop'] = 'name';
  }
}

/**
 * Implements hook_entity_view().
 */
function ombublog_entity_view($entity, $type, $view_mode) {
  if ($type == 'profile2' && $entity->type == 'blog_author' && $view_mode == 'page') {
    // Add listing of all blog posts by this author.
    $query = db_select('node', 'n')->extend('PagerDefault');
    $query->join('field_data_field_authors', 'fa', 'n.nid = fa.entity_id AND fa.deleted = 0');

    $query
      ->fields('n', array('nid'))
      ->condition(db_or()->condition('n.uid', $entity->uid)->condition('fa.field_authors_target_id', $entity->uid))
      ->orderBy('n.created', 'DESC');

    $nids = $query->execute()->fetchCol();

    if ($nids) {
      $nodes = node_load_multiple($nids);
      $entity->content['blog_posts'] = array(
        'nodes' => node_view_multiple($nodes, 'teaser'),
        'pager' => array(
          '#theme' => 'pager',
        ),
      );
    }
  }
}

/**
 * Implements hook_views_pre_render().
 */
function ombublog_views_pre_render(&$view) {
  // Add contextual title based on searched input.
  if ($view->name == 'ombublog' && $view->current_display == 'ombublog_listing') {
    $filters = array();

    // Anonymous function to help format taxonomy term inputs.
    $term_formatter = function($terms, $vocab) {
      $output = '';

      $items = array();
      foreach ($terms as $term) {
        $items[] = entity_label('taxonomy_term', $term);
      }

      if ($items) {
        $output = t('!vocab %items', array(
          '!vocab' => strtolower($vocab->name),
          '%items' => join(', ', $items),
        ));
      }

      return $output;
    };

    if (isset($view->exposed_input['category']) && $category = explode(',', $view->exposed_input['category'])) {
      $terms = taxonomy_term_load_multiple($category);
      $filters[] = $term_formatter($terms, taxonomy_vocabulary_machine_name_load(variable_get('ombublog_category_vocabulary', '')));
    }
    if (isset($view->exposed_input['keys']) && $keys = trim($view->exposed_input['keys'])) {
      $filters[] = t('keywords %keys', array(
        '%keys' => $keys,
      ));
    }
    if (isset($view->exposed_input['tags']) && $tags = explode(',', $view->exposed_input['tags'])) {
      $terms = array();
      foreach ($tags as $tag) {
        $term = taxonomy_get_term_by_name($tag);
        if ($term) {
          $terms[] = current($term)->tid;
        }
      }
      $terms = taxonomy_term_load_multiple($terms);
      $filters[] = $term_formatter($terms, taxonomy_vocabulary_machine_name_load(variable_get('ombublog_tags_vocabulary', '')));
    }
  }

  if (isset($filters)) {
    $view->attachment_before .= t('<h3>Posts matching !filters</h3>', array(
      '!filters' => join(' and ', $filters),
    ));
  }
}

/**
 * Theme callback.
 *
 * Renders a list of taxonomy terms in a comma seprated list.
 */
function theme_taxonomy_comma_list($variables) {
  if (!isset($variables['element']['#items'])) {
    return;
  }

  // Pass variables through field preprocessing, since this isn't actually a
  // field theme function.
  template_preprocess_field($variables, '');
  template_process_field($variables, '');

  $output = '';

  // Render the label, if it's not hidden.
  if (!$variables['label_hidden']) {
    $output .= '<div class="field-label"' . $variables['title_attributes'] . '>' . $variables['label'] . ':&nbsp;</div>';
  }

  // Build links array.
  $links = array();
  foreach ($variables['items'] as $delta => $item) {
    $links[] = drupal_render($item);
  }

  $output .= implode('<span>, </span>', $links);

  // Render the top-level DIV.
  $output = '<div class="' . $variables['classes'] . '"' . $variables['attributes'] . '>' . $output . '</div>';

  return $output;
}

/**
 * Block function for the archives list.
 */
function ombublog_archive_block() {
  $year = 'YEAR(FROM_UNIXTIME(n.created))';
  $month = 'MONTH(FROM_UNIXTIME(n.created))';
  $query = <<<QUERY
SELECT
CONCAT(
  $year,
  '-',
  $month
) AS date,
COUNT(*) AS count
FROM {node} n
WHERE
n.type = :type AND
n.status <> 0
GROUP BY $year, $month
ORDER BY
$year DESC,
$month DESC
QUERY;
  $results = db_query($query, array(':type' => 'blog_post'))->fetchAllKeyed();

  // Build up a list of options for all available months between first post and
  // now.
  $start_date = db_query('SELECT MIN(created) FROM {node} WHERE type = :type', array(
    ':type' => 'blog_post',
  ))->fetchField();
  $current_date = time();
  while ($start_date < $current_date) {
    $key = date('Y-n', $start_date);
    $options[date('Y', $start_date)][$key] = array(
      '!month' => date('F', $start_date),
      '!count' => isset($results[$key]) ? $results[$key] : 0,
    );
    $start_date = strtotime(date('m/d/Y', $start_date) . ' + 1 month');
  }

  return array(
    '#theme' => 'ombublog_archive_list',
    '#options' => $options,
  );
}

/**
 * Theme callback for archive list.
 *
 * Defaults to select list with optgroups. An option for each month will be
 * created, and if there are no blog posts in that month the option will be
 * disabled.
 */
function theme_ombublog_archive_list($variables) {
  // Build up select list. Can't use theme_select() since there's no support for
  // disabling options, which is needed for options without blog posts.
  $output = '<select name="blog-archive">';
  foreach ($variables['options'] as $year => $months) {
    $output .= '<optgroup label="' . $year . '">';

    foreach ($months as $key => $month) {
      $output .= t('<option value="!key" !disabled>!month (!count)</option>', array(
        '!key' => $key,
        '!disabled' => $month['!count'] ? '' : 'disabled="disabled"',
      ) + $month);
    }

    $output .= '</optgroup>';
  }
  $output .= '</select>';

  return $output;
}

function _ombublog_block_get_rss_feed() {
  return l(t('RSS'), ombublog_get_base_url() . '/feed', array(
    'attributes' => array(
      'class' => 'rss-icon',
      'title' => 'RSS Feed',
    ),
  ));
}

function ombublog_url_safe_string($string) {
  $string = strtr(drupal_strtolower($string), array(' ' => '-', '_' => '-', '[' => '-', ']' => ''));
  $string = preg_replace('/[^A-Za-z0-9\-_]/', '', $string);
  $string = preg_replace('/\-+/', '-', $string);
  return $string;
}
